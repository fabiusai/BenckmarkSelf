<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Analytics Dashboard</title>
    <link rel="icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #3b3b3a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 102, 204, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #0066cc;
        }

        .section h2 {
            color: #0066cc;
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #3b3b3a;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3b3b3a;
        }

        input[type="file"],
        select,
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        select[multiple] {
            height: 150px;
            padding: 10px;
        }

        input[type="file"]:focus,
        select:focus,
        input[type="text"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
        }

        .search-container {
            position: relative;
        }

        .search-container input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .btn {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #0066cc;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: auto;
        }

        .error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        #chartPreview {
            width: 100%;
            max-width: 100%;
            height: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Social Analytics Dashboard</h1>
            <p>Analizza le performance dei tuoi contenuti social con grafici professionali</p>
        </div>

        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
                Carica i tuoi dati Excel
            </h2>
            <div class="form-group">
                <label for="fileInput">Seleziona il file Excel con i dati dei social media</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>
            <div id="fileStatus" class="loading">
                <div class="spinner"></div>
                Caricamento e analisi del file in corso...
            </div>
        </div>

        <div id="configSections" class="hidden">
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                    </svg>
                    Configurazione Analisi
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Dal</label>
                        <input type="date" id="startDate" disabled>
                    </div>
                    <div class="form-group">
                        <label for="endDate">Al</label>
                        <input type="date" id="endDate" disabled>
                    </div>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="allDataCheckbox" checked>
                    <label for="allDataCheckbox">Usa tutti i dati (ignora il periodo)</label>
                </div>

                <div class="form-group">
                    <label for="topicTitleInput">Titolo per l'argomento/i selezionato/i</label>
                    <input type="text" id="topicTitleInput" placeholder="Es: 'Educazione Finanziaria'" />
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="topicFilter">Filtra argomenti</label>
                        <div class="search-container">
                            <input type="text" id="topicFilter" placeholder="Digita per filtrare..." />
                            <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20">
                                <path d="M15.5 14h-.79l-.28-.27A6.518 6.518 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5.5 12.49 5.5 11S7.01 8 9.5 8 13.5 9.51 13.5 11 11.99 14 9.5 14z" fill="currentColor"/>
                            </svg>
                        </div>
                    </div>
                    <div class="form-group">
                         <label for="topicSelect">Argomenti da analizzare (Ctrl+Click per selezionare più)</label>
                        <select id="topicSelect" multiple>
                            </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kpiSelect">Metrica da analizzare</label>
                        <select id="kpiSelect">
                            <option value="Interazioni">Interazioni</option>
                            <option value="Visualizzazioni">Visualizzazioni</option>
                            <option value="Persone raggiunte">Persone raggiunte</option>
                            <option value="Click">Click</option>
                            <option value="Like e reazioni">Like e reazioni</option>
                            <option value="Condivisioni">Condivisioni</option>
                            <option value="Commenti">Commenti</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="channelSelect">Canale</label>
                        <select id="channelSelect">
                            <option value="tutti">Tutti i canali</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="periodSelect">Raggruppamento temporale</label>
                        <select id="periodSelect">
                            <option value="day">Giornaliero</option>
                            <option value="week">Settimanale</option>
                            <option value="15days">Quindicinale</option>
                            <option value="month" selected>Mensile</option>
                        </select>
                    </div>
                </div>

                <button id="generateBtn" class="btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3,3H11V7H7V11H3V3M13,3H21V7H17V11H13V3M3,13H11V17H7V21H3V13M13,13H21V17H17V21H13V13Z" />
                    </svg>
                    Genera Analisi Benchmark
                </button>
            </div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="section">
                <h2 id="resultsTitle">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3,3V21H21V19H5V3H3M7,17H9V10H7V17M11,17H13V6H11V17M15,17H17V12H15V17M19,17H21V8H19V17Z" />
                    </svg>
                    Risultati dell'Analisi
                </h2>

                <div id="statsContent">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div id="totalPosts" class="stat-value">-</div>
                            <div class="stat-label">Post Totali</div>
                        </div>
                        <div class="stat-card">
                            <div id="topicPosts" class="stat-value">-</div>
                            <div id="topicPostsLabel" class="stat-label">Numero post Argomento Selez.</div>
                        </div>
                        <div class="stat-card">
                            <div id="avgOverall" class="stat-value">-</div>
                            <div class="stat-label">Media Generale</div>
                        </div>
                        <div class="stat-card">
                            <div id="avgTopic" class="stat-value">-</div>
                            <div id="avgTopicLabel" class="stat-label">Media Argomento Selez.</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Grafico Benchmark</h3>
                    <svg id="chartPreview" width="100%" height="300" style="border: 2px solid #e9ecef; border-radius: 8px;">
                        <text x="50%" y="50%" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" fill="#666">
                            Genera un'analisi per visualizzare il grafico
                        </text>
                    </svg>
                </div>

                <div class="download-section">
                    <button id="downloadChart" class="btn btn-secondary" onclick="downloadSVG('chart')">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        Scarica Grafico SVG
                    </button>
                    <button id="downloadResults" class="btn btn-secondary" onclick="downloadResultsAsImage()">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3M13.5,7A1.5,1.5 0 0,0 12,8.5A1.5,1.5 0 0,0 13.5,10A1.5,1.5 0 0,0 15,8.5A1.5,1.5 0 0,0 13.5,7M7,15.5L9,13L11,15.5L13.5,12L17,15.5H7Z" />
                        </svg>
                        Scarica Dati di Sintesi come Immagine
                    </button>
                </div>
            </div>
        </div>

        <div id="message" class="hidden"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Variabili globali
        let excelData = [];
        let allTopics = [];
        let allChannels = [];

        // Riferimenti DOM
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');
        const configSections = document.getElementById('configSections');
        const resultsSection = document.getElementById('resultsSection');
        const topicTitleInput = document.getElementById('topicTitleInput');
        const topicFilter = document.getElementById('topicFilter');
        const topicSelect = document.getElementById('topicSelect');
        const kpiSelect = document.getElementById('kpiSelect');
        const channelSelect = document.getElementById('channelSelect');
        const periodSelect = document.getElementById('periodSelect');
        const generateBtn = document.getElementById('generateBtn');
        const messageDiv = document.getElementById('message');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const allDataCheckbox = document.getElementById('allDataCheckbox');
        const topicPostsLabel = document.getElementById('topicPostsLabel');
        const avgTopicLabel = document.getElementById('avgTopicLabel');

        // Event listeners
        fileInput.addEventListener('change', handleFileUpload);
        topicFilter.addEventListener('input', filterTopics);
        generateBtn.addEventListener('click', generateAnalysis);
        allDataCheckbox.addEventListener('change', (e) => {
            startDateInput.disabled = e.target.checked;
            endDateInput.disabled = e.target.checked;
        });
        kpiSelect.addEventListener('change', updateTopicLabels); 
        topicTitleInput.addEventListener('input', updateTopicLabels);


        function showMessage(message, isError = false) {
            messageDiv.textContent = message;
            messageDiv.className = isError ? 'error' : 'success';
            messageDiv.classList.remove('hidden');
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        function updateButtonState(button, state, originalText) {
            switch(state) {
                case 'loading':
                    button.disabled = true;
                    button.innerHTML = '<div class="spinner"></div> Caricamento...';
                    break;
                case 'success':
                    button.disabled = true;
                    button.innerHTML = '✓ Completato!';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                    break;
                case 'error':
                    button.disabled = true;
                    button.innerHTML = '✗ Errore';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                    break;
                default:
                    button.disabled = false;
                    button.innerHTML = originalText;
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileStatus.style.display = 'block';
            
            try {
                const data = await readExcelFile(file);
                processExcelData(data);
                populateSelectors();
                configSections.classList.remove('hidden');
                showMessage('File caricato con successo!', false);
                updateTopicLabels();
            } catch (error) {
                console.error('Errore nel caricamento:', error);
                showMessage(error.message || 'Errore nel caricamento del file. Verificare il formato.', true);
            }
            
            fileStatus.style.display = 'none';
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function parseDate(dateValue) {
            if (!dateValue) return null;
            
            let date;
            try {
                if (typeof dateValue === 'number') {
                    date = new Date((dateValue - 25569) * 86400 * 1000);
                } else if (typeof dateValue === 'string') {
                    if (dateValue.includes('/')) {
                        const parts = dateValue.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1; 
                            const year = parseInt(parts[2], 10);
                            date = new Date(Date.UTC(year, month, day));
                        } else {
                            date = new Date(dateValue);
                        }
                    } else {
                        date = new Date(dateValue);
                    }
                } else if (dateValue instanceof Date) {
                    date = new Date(dateValue);
                }
                
                if (isNaN(date.getTime())) {
                    return null;
                }
                
                return date;

            } catch (error) {
                console.warn('Errore nel parsing della data:', dateValue, error);
                return null;
            }
        }

        function processExcelData(data) {
            const editorialData = data.filter(row => 
                row.Campagna && row.Campagna.toString().toLowerCase() === 'editoriale'
            );

            if (editorialData.length === 0) {
                throw new Error('Nessun dato trovato con Campagna = "Editoriale"');
            }

            excelData = editorialData.map(row => ({
                ...row,
                parsedDate: parseDate(row.Data)
            })).filter(row => row.parsedDate !== null);

            if (excelData.length === 0) {
                throw new Error('Nessun dato con date valide trovato.');
            }

            allTopics = [...new Set(excelData.map(row => row.Argomento).filter(Boolean))].sort();
            allChannels = [...new Set(excelData.map(row => row.Canale).filter(Boolean))].sort();

            console.log(`Caricati ${excelData.length} record validi.`);
        }

        function populateSelectors() {
            topicSelect.innerHTML = '';
            allTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });

            channelSelect.innerHTML = '<option value="tutti">Tutti i canali</option>';
            allChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
        }

        function filterTopics() {
            const filter = topicFilter.value.toLowerCase();
            const currentlySelected = Array.from(topicSelect.selectedOptions).map(opt => opt.value);
            
            topicSelect.innerHTML = '';
            
            allTopics.forEach(topic => {
                if (topic.toLowerCase().includes(filter)) {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    if (currentlySelected.includes(topic)) {
                        option.selected = true;
                    }
                    topicSelect.appendChild(option);
                }
            });
        }

        function updateTopicLabels() {
            const topicTitle = topicTitleInput.value.trim();
            const kpiText = kpiSelect.options[kpiSelect.selectedIndex].text;

            topicPostsLabel.innerHTML = `Numero post<br>${topicTitle || 'Argomento Selez.'}`;
            avgTopicLabel.innerHTML = `Media ${kpiText}<br>${topicTitle || 'Argomento Selez.'}`;
        }


        function generateAnalysis() {
            const selectedTopics = Array.from(topicSelect.selectedOptions).map(opt => opt.value);
            const kpi = kpiSelect.value;
            const channel = channelSelect.value;
            const period = periodSelect.value;
            const useAllData = allDataCheckbox.checked;
            const startDate = useAllData ? null : new Date(startDateInput.value);
            const endDate = useAllData ? null : new Date(endDateInput.value);
            const topicTitle = topicTitleInput.value.trim();

            if (selectedTopics.length === 0) {
                showMessage('Seleziona almeno un argomento per continuare.', true);
                return;
            }
            if (!useAllData && (isNaN(startDate.getTime()) || isNaN(endDate.getTime()))) {
                showMessage('Seleziona un periodo valido.', true);
                return;
            }
            if (!useAllData && startDate > endDate) {
                 showMessage('La data di inizio non può essere successiva alla data di fine.', true);
                return;
            }
            if (!topicTitle) {
                showMessage('Inserisci un titolo per l\'argomento.', true);
                return;
            }

            const originalText = generateBtn.innerHTML;
            updateButtonState(generateBtn, 'loading', originalText);

            try {
                const analysisData = prepareAnalysisData(selectedTopics, kpi, channel, period, { useAllData, startDate, endDate });
                createCharts(analysisData, selectedTopics, kpi, channel, period);
                updateStatistics(analysisData, selectedTopics, channel, kpi, topicTitle, { useAllData, startDate, endDate });
                
                resultsSection.classList.remove('hidden');
                updateButtonState(generateBtn, 'success', originalText);
                showMessage('Analisi generata con successo!', false);
                
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Errore nella generazione:', error);
                updateButtonState(generateBtn, 'error', originalText);
                showMessage('Errore nella generazione dell\'analisi.', true);
            }
        }

        function prepareAnalysisData(topics, kpi, channel, period, dateRange) {
            let workingData = excelData;

            if (!dateRange.useAllData) {
                const endOfDay = new Date(dateRange.endDate);
                endOfDay.setHours(23, 59, 59, 999);
                
                workingData = workingData.filter(row => {
                    const rowDate = row.parsedDate;
                    return rowDate >= dateRange.startDate && rowDate <= endOfDay;
                });
            }

            if (channel !== 'tutti') {
                workingData = workingData.filter(row => row.Canale === channel);
            }

            const groupedData = groupByPeriod(workingData, period);
            
            const analysisData = [];
            
            Object.keys(groupedData).sort().forEach(periodKey => {
                const periodData = groupedData[periodKey];
                const allPosts = periodData;
                const topicPosts = periodData.filter(row => topics.includes(row.Argomento));
                
                if (allPosts.length > 0) {
                    const avgAll = calculateAverage(allPosts, kpi);
                    const avgTopic = topicPosts.length > 0 ? calculateAverage(topicPosts, kpi) : null;
                    
                    if (avgAll > 0 || (avgTopic !== null && avgTopic > 0)) {
                        analysisData.push({
                            period: periodKey,
                            avgAll: avgAll,
                            avgTopic: avgTopic,
                            totalPosts: allPosts.length,
                            topicPosts: topicPosts.length
                        });
                    }
                }
            });

            return analysisData;
        }

        function groupByPeriod(data, period) {
            const grouped = {};
            
            data.forEach(row => {
                const date = row.parsedDate;
                if (!date) return;
                
                let periodKey;
                switch (period) {
                    case 'day':
                        periodKey = date.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const week = getWeekNumber(date);
                        periodKey = `${date.getUTCFullYear()}-W${week.toString().padStart(2, '0')}`;
                        break;
                    case '15days':
                        const day15 = Math.ceil(date.getUTCDate() / 15);
                        periodKey = `${date.getUTCFullYear()}-${(date.getUTCMonth() + 1).toString().padStart(2, '0')}-Q${day15}`;
                        break;
                    case 'month':
                        periodKey = `${date.getUTCFullYear()}-${(date.getUTCMonth() + 1).toString().padStart(2, '0')}`;
                        break;
                }
                
                if (!grouped[periodKey]) {
                    grouped[periodKey] = [];
                }
                grouped[periodKey].push(row);
            });
            
            return grouped;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function calculateAverage(data, kpi) {
            const values = data.map(row => {
                const val = parseFloat(row[kpi]);
                return isNaN(val) ? null : val;
            }).filter(val => val !== null);
            
            return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                let formatted = (num / 1000000).toFixed(2);
                formatted = formatted.replace(/\.?0+$/, '');
                return formatted.replace('.', ',') + 'M';
            }
            if (num >= 1000) {
                let formatted = (num / 1000).toFixed(2);
                formatted = formatted.replace(/\.?0+$/, '');
                return formatted.replace('.', ',') + 'K';
            }
            return Math.round(num).toString().replace('.', ',');
        }

        function formatPeriodLabel(periodKey, period) {
            switch (period) {
                case 'day':
                    return new Date(periodKey + 'T00:00:00Z').toLocaleDateString('it-IT', { timeZone: 'UTC', day: '2-digit', month: '2-digit' });
                case 'week':
                    const [year, week] = periodKey.split('-W');
                    return `S${week}/${year.substr(2)}`;
                case '15days':
                    const [y, m, q] = periodKey.split('-');
                    const quarter = q === 'Q1' ? '1-15' : '16-31';
                    return `${quarter}/${m}`;
                case 'month':
                    const [yr, mn] = periodKey.split('-');
                    return `${mn}/${yr.substr(2)}`;
                default:
                    return periodKey;
            }
        }

        function createCharts(analysisData, topic, kpi, channel, period) {
            createMainChart(analysisData, topic, kpi, channel, period);
        }

        function createMainChart(analysisData, topic, kpi, channel, period) {
            const svg = document.getElementById('chartPreview');
            svg.innerHTML = '';
            
            const width = 1200;
            const height = 300;
            const margin = { top: 40, right: 40, bottom: 50, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            const lightBlue = '#d6e6fe';
            const darkBlue = '#0066cc';
            const gray = '#999999';
            const darkGray = '#3b3b3a';

            if (analysisData.length === 0) {
                const emptyText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                emptyText.setAttribute('x', '50%');
                emptyText.setAttribute('y', '50%');
                emptyText.setAttribute('text-anchor', 'middle');
                emptyText.setAttribute('font-family', 'Arial, sans-serif');
                emptyText.setAttribute('font-size', '16');
                emptyText.setAttribute('fill', '#666');
                emptyText.textContent = "Nessun dato da visualizzare per i filtri selezionati.";
                svg.appendChild(emptyText);
                return;
            };

            const maxValue = Math.max(...analysisData.flatMap(d => [d.avgAll, d.avgTopic || 0]));
            const yScale = maxValue > 0 ? chartHeight / maxValue : 1;

            const barWidth = chartWidth / analysisData.length * 0.8;
            const barSpacing = chartWidth / analysisData.length * 0.2;

            const numTicks = 5;
            for (let i = 0; i <= numTicks; i++) {
                const tickValue = (maxValue / numTicks) * i;
                const yPos = margin.top + chartHeight - (tickValue * yScale);

                if (i > 0) {
                    const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    gridLine.setAttribute('x1', margin.left);
                    gridLine.setAttribute('y1', yPos);
                    gridLine.setAttribute('x2', margin.left + chartWidth);
                    gridLine.setAttribute('y2', yPos);
                    gridLine.setAttribute('stroke', '#f8f8f8');
                    gridLine.setAttribute('stroke-width', '0.5');
                    svg.appendChild(gridLine);
                }

                const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                yLabel.setAttribute('x', margin.left - 10);
                yLabel.setAttribute('y', yPos + 4);
                yLabel.setAttribute('text-anchor', 'end');
                yLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                yLabel.setAttribute('font-size', '11');
                yLabel.setAttribute('fill', gray);
                yLabel.textContent = formatNumber(tickValue);
                svg.appendChild(yLabel);
            }

            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('x1', margin.left);
            yAxis.setAttribute('y1', margin.top);
            yAxis.setAttribute('x2', margin.left);
            yAxis.setAttribute('y2', margin.top + chartHeight);
            yAxis.setAttribute('stroke', '#cccccc');
            yAxis.setAttribute('stroke-width', '0.5');
            svg.appendChild(yAxis);

            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('x1', margin.left);
            xAxis.setAttribute('y1', margin.top + chartHeight);
            xAxis.setAttribute('x2', margin.left + chartWidth);
            xAxis.setAttribute('y2', margin.top + chartHeight);
            xAxis.setAttribute('stroke', '#cccccc');
            xAxis.setAttribute('stroke-width', '0.5');
            svg.appendChild(xAxis);

            analysisData.forEach((data, index) => {
                const x = margin.left + index * (chartWidth / analysisData.length) + barSpacing / 2;

                const barHeight = data.avgAll * yScale;
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', x);
                bar.setAttribute('y', margin.top + chartHeight - barHeight);
                bar.setAttribute('width', barWidth);
                bar.setAttribute('height', barHeight);
                bar.setAttribute('fill', lightBlue);
                svg.appendChild(bar);

                if (data.avgTopic !== null) {
                    const markerY = margin.top + chartHeight - (data.avgTopic * yScale);
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    marker.setAttribute('cx', x + barWidth / 2);
                    marker.setAttribute('cy', markerY);
                    marker.setAttribute('r', '6');
                    marker.setAttribute('fill', darkBlue);
                    marker.setAttribute('stroke', 'white');
                    marker.setAttribute('stroke-width', '2');
                    svg.appendChild(marker);

                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', x + barWidth / 2);
                    valueLabel.setAttribute('y', markerY - 15);
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                    valueLabel.setAttribute('font-size', '14');
                    valueLabel.setAttribute('font-weight', 'bold');
                    valueLabel.setAttribute('fill', darkBlue);
                    valueLabel.textContent = formatNumber(data.avgTopic);
                    svg.appendChild(valueLabel);
                }

                const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                xLabel.setAttribute('x', x + barWidth / 2);
                xLabel.setAttribute('y', margin.top + chartHeight + 20);
                xLabel.setAttribute('text-anchor', 'middle');
                xLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                xLabel.setAttribute('font-size', '12');
                xLabel.setAttribute('fill', darkGray);
                xLabel.textContent = formatPeriodLabel(data.period, period);
                svg.appendChild(xLabel);
            });
        }

        function updateStatistics(analysisData, topics, channel, kpi, topicTitle, dateRange) {
            let filteredData = excelData;

            if (!dateRange.useAllData) {
                 const endOfDay = new Date(dateRange.endDate);
                endOfDay.setHours(23, 59, 59, 999);
                filteredData = filteredData.filter(row => {
                    const rowDate = row.parsedDate;
                    return rowDate >= dateRange.startDate && rowDate <= endOfDay;
                });
            }
            if (channel !== 'tutti') {
                filteredData = filteredData.filter(row => row.Canale === channel);
            }
            
            const totalPosts = filteredData.length;
            const topicPostsCount = filteredData.filter(row => topics.includes(row.Argomento)).length;
            
            const validPeriods = analysisData.filter(d => d.avgAll > 0);
            const avgAll = validPeriods.length > 0 ? 
                validPeriods.reduce((sum, d) => sum + d.avgAll, 0) / validPeriods.length : 0;
            
            const topicPeriods = analysisData.filter(d => d.avgTopic !== null && d.avgTopic > 0);
            const avgTopic = topicPeriods.length > 0 ? 
                topicPeriods.reduce((sum, d) => sum + d.avgTopic, 0) / topicPeriods.length : 0;

            document.getElementById('totalPosts').textContent = formatNumber(totalPosts);
            document.getElementById('topicPosts').textContent = formatNumber(topicPostsCount);
            document.getElementById('avgOverall').textContent = formatNumber(avgAll);
            document.getElementById('avgTopic').textContent = formatNumber(avgTopic);

            const kpiText = kpiSelect.options[kpiSelect.selectedIndex].text;
            
            // *** MODIFICA APPLICATA QUI ***
            topicPostsLabel.innerHTML = `Numero post<br>${topicTitle}`;
            avgTopicLabel.innerHTML = `Media ${kpiText}<br>${topicTitle}`;
        }

        function downloadSVG(type) {
            const svgElement = document.getElementById('chartPreview');
            
            const svgContent = new XMLSerializer().serializeToString(svgElement);
            const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'grafico_benchmark.svg';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            const button = document.getElementById('downloadChart');
            const originalText = button.innerHTML;
            updateButtonState(button, 'success', originalText);
        }

        async function downloadResultsAsImage() {
            const statsContent = document.getElementById('statsContent');
            const button = document.getElementById('downloadResults');
            const originalText = button.innerHTML;
            
            try {
                updateButtonState(button, 'loading', originalText);
                
                const canvas = await html2canvas(statsContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: statsContent.offsetWidth,
                    height: statsContent.offsetHeight
                });
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'dati_sintesi.png';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    updateButtonState(button, 'success', originalText);
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Errore nel download dell\'immagine:', error);
                updateButtonState(button, 'error', originalText);
            }
        }
    </script>
</body>
</html>
