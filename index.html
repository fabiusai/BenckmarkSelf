<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Analytics Dashboard</title>
    <link rel="icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #3b3b3a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 102, 204, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #0066cc;
        }

        .section h2 {
            color: #0066cc;
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #3b3b3a;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3b3b3a;
        }

        input[type="file"],
        select,
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="file"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .search-container {
            position: relative;
        }

        .search-container input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .btn {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #0066cc;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: auto;
        }

        .error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        #chartPreview, #statsPreview {
            width: 100%;
            max-width: 100%;
            height: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Social Analytics Dashboard</h1>
            <p>Analizza le performance dei tuoi contenuti social con grafici professionali</p>
        </div>

        <!-- Sezione 1: Caricamento File -->
        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                1. Caricamento File Excel
            </h2>
            <div class="form-group">
                <label for="fileInput">Seleziona il file Excel con i dati di engagement:</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>
            <div id="fileStatus" class="loading">
                <div class="spinner"></div>
                <span>Caricamento in corso...</span>
            </div>
        </div>

        <!-- Sezioni di configurazione (nascoste inizialmente) -->
        <div id="configSections" class="hidden">
            <!-- Sezione 2: Selezione Argomento -->
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                    </svg>
                    2. Selezione Argomento
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="topicSelect">Argomento:</label>
                        <select id="topicSelect">
                            <option value="">Seleziona un argomento...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="topicFilter">Filtra argomenti:</label>
                        <div class="search-container">
                            <input type="text" id="topicFilter" placeholder="Cerca argomento...">
                            <svg class="search-icon icon" viewBox="0 0 24 24">
                                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione 3: Selezione KPI e Canale -->
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
                    </svg>
                    3. Configurazione Analisi
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="kpiSelect">KPI da analizzare:</label>
                        <select id="kpiSelect">
                            <option value="Visualizzazioni">Visualizzazioni</option>
                            <option value="Interazioni">Interazioni</option>
                            <option value="Commenti">Commenti</option>
                            <option value="Like e reazioni">Like e reazioni</option>
                            <option value="Condivisioni">Condivisioni</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="channelSelect">Canale:</label>
                        <select id="channelSelect">
                            <option value="tutti">Tutti i canali</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="periodSelect">Raggruppamento temporale:</label>
                        <select id="periodSelect">
                            <option value="day">Giorno</option>
                            <option value="week">Settimana</option>
                            <option value="15days">15 giorni</option>
                            <option value="month">Mese</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <button id="generateBtn" class="btn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M5,3C3.89,3 3,3.89 3,5V19C3,20.11 3.89,21 5,21H19C20.11,21 21,20.11 21,19V5C21,3.89 20.11,3 19,3H5M5,5H19V19H5V5M7,7V9H17V7H7M7,11V13H17V11H7M7,15V17H14V15H7Z"/>
                        </svg>
                        Genera Analisi
                    </button>
                </div>
            </div>
        </div>

        <!-- Sezione Risultati (nascosta inizialmente) -->
        <div id="resultsSection" class="hidden">
            <!-- Sezione 6: Informazioni Sintetiche -->
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                    </svg>
                    Informazioni Sintetiche
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPosts">0</div>
                        <div class="stat-label">Totale post pubblicati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="topicPosts">0</div>
                        <div class="stat-label">Post sull'argomento selezionato</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgOverall">0</div>
                        <div class="stat-label">Media complessiva KPI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgTopic">0</div>
                        <div class="stat-label">Media KPI argomento</div>
                    </div>
                </div>
                <div class="chart-container">
                    <svg id="statsPreview" width="100%" height="250"></svg>
                    <div class="download-section">
                        <button id="downloadStats" class="btn btn-secondary">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            Scarica Riepilogo SVG
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sezione 7: Grafico Principale -->
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M22,21H2V3H4V19H6V17H10V19H12V16H16V19H18V17H22V21Z"/>
                    </svg>
                    Grafico di Benchmark
                </h2>
                <div class="chart-container">
                    <svg id="chartPreview" width="100%" height="350"></svg>
                    <div class="download-section">
                        <button id="downloadChart" class="btn btn-secondary">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            Scarica Grafico SVG
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMsg" class="error hidden"></div>
        <div id="successMsg" class="success hidden"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        let excelData = [];
        let filteredData = [];
        let allTopics = [];
        let allChannels = [];

        // Elementi DOM
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');
        const configSections = document.getElementById('configSections');
        const resultsSection = document.getElementById('resultsSection');
        const topicSelect = document.getElementById('topicSelect');
        const topicFilter = document.getElementById('topicFilter');
        const kpiSelect = document.getElementById('kpiSelect');
        const channelSelect = document.getElementById('channelSelect');
        const periodSelect = document.getElementById('periodSelect');
        const generateBtn = document.getElementById('generateBtn');
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');

        // Event Listeners
        fileInput.addEventListener('change', handleFileUpload);
        topicFilter.addEventListener('input', filterTopics);
        generateBtn.addEventListener('click', generateAnalysis);
        document.getElementById('downloadChart').addEventListener('click', () => downloadSVG('chart'));
        document.getElementById('downloadStats').addEventListener('click', () => downloadSVG('stats'));

        function showMessage(message, isError = false) {
            const msgElement = isError ? errorMsg : successMsg;
            const otherMsg = isError ? successMsg : errorMsg;
            
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            otherMsg.classList.add('hidden');
            
            setTimeout(() => msgElement.classList.add('hidden'), 5000);
        }

        function updateButtonState(button, state, originalText) {
            switch(state) {
                case 'loading':
                    button.disabled = true;
                    button.innerHTML = '<div class="spinner"></div> Caricamento...';
                    break;
                case 'success':
                    button.disabled = true;
                    button.innerHTML = '✓ Completato!';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                    break;
                case 'error':
                    button.disabled = true;
                    button.innerHTML = '✗ Errore';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                    break;
                default:
                    button.disabled = false;
                    button.innerHTML = originalText;
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileStatus.style.display = 'block';
            
            try {
                const data = await readExcelFile(file);
                processExcelData(data);
                populateSelectors();
                configSections.classList.remove('hidden');
                showMessage('File caricato con successo!', false);
            } catch (error) {
                console.error('Errore nel caricamento:', error);
                showMessage('Errore nel caricamento del file. Verificare il formato.', true);
            }
            
            fileStatus.style.display = 'none';
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function processExcelData(data) {
            // Filtra solo i dati con Campagna = "Editoriale"
            excelData = data.filter(row => 
                row.Campagna && row.Campagna.toString().toLowerCase() === 'editoriale'
            );

            if (excelData.length === 0) {
                throw new Error('Nessun dato trovato con Campagna = "Editoriale"');
            }

            // Estrai argomenti e canali unici
            allTopics = [...new Set(excelData.map(row => row.Argomento).filter(Boolean))].sort();
            allChannels = [...new Set(excelData.map(row => row.Canale).filter(Boolean))].sort();

            console.log(`Caricati ${excelData.length} record con Campagna "Editoriale"`);
            console.log('Argomenti trovati:', allTopics);
            console.log('Canali trovati:', allChannels);
        }

        function populateSelectors() {
            // Popola argomenti
            topicSelect.innerHTML = '<option value="">Seleziona un argomento...</option>';
            allTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });

            // Popola canali
            channelSelect.innerHTML = '<option value="tutti">Tutti i canali</option>';
            allChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
        }

        function filterTopics() {
            const filter = topicFilter.value.toLowerCase();
            
            // Prima rimuovi tutte le opzioni tranne la prima
            const firstOption = topicSelect.children[0];
            topicSelect.innerHTML = '';
            topicSelect.appendChild(firstOption);
            
            // Aggiungi solo le opzioni che corrispondono al filtro
            allTopics.forEach(topic => {
                if (topic.toLowerCase().includes(filter)) {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    topicSelect.appendChild(option);
                }
            });
        }

        function generateAnalysis() {
            const topic = topicSelect.value;
            const kpi = kpiSelect.value;
            const channel = channelSelect.value;
            const period = periodSelect.value;

            if (!topic) {
                showMessage('Seleziona un argomento per continuare.', true);
                return;
            }

            const originalText = generateBtn.innerHTML;
            updateButtonState(generateBtn, 'loading', originalText);

            try {
                const analysisData = prepareAnalysisData(topic, kpi, channel, period);
                createCharts(analysisData, topic, kpi, channel, period);
                updateStatistics(analysisData, topic, kpi);
                
                resultsSection.classList.remove('hidden');
                updateButtonState(generateBtn, 'success', originalText);
                showMessage('Analisi generata con successo!', false);
                
                // Scroll to results
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Errore nella generazione:', error);
                updateButtonState(generateBtn, 'error', originalText);
                showMessage('Errore nella generazione dell\'analisi.', true);
            }
        }

        function prepareAnalysisData(topic, kpi, channel, period) {
            // Filtra i dati in base al canale
            let workingData = excelData;
            if (channel !== 'tutti') {
                workingData = excelData.filter(row => row.Canale === channel);
            }

            // Converti le date e raggruppa per periodo
            const groupedData = groupByPeriod(workingData, period);
            
            // Calcola medie per periodo
            const analysisData = [];
            
            Object.keys(groupedData).sort().forEach(periodKey => {
                const periodData = groupedData[periodKey];
                const allPosts = periodData;
                const topicPosts = periodData.filter(row => row.Argomento === topic);
                
                if (allPosts.length > 0) {
                    const avgAll = calculateAverage(allPosts, kpi);
                    const avgTopic = topicPosts.length > 0 ? calculateAverage(topicPosts, kpi) : null;
                    
                    analysisData.push({
                        period: periodKey,
                        avgAll: avgAll,
                        avgTopic: avgTopic,
                        totalPosts: allPosts.length,
                        topicPosts: topicPosts.length
                    });
                }
            });

            return analysisData;
        }

        function groupByPeriod(data, period) {
            const grouped = {};
            
            data.forEach(row => {
                if (!row.Data) return;
                
                let date;
                try {
                    // Prova diversi formati di data
                    if (typeof row.Data === 'number') {
                        date = new Date((row.Data - 25569) * 86400 * 1000); // Excel date
                    } else {
                        date = new Date(row.Data);
                    }
                } catch {
                    return; // Salta righe con date non valide
                }
                
                if (isNaN(date.getTime())) return;
                
                let periodKey;
                switch (period) {
                    case 'day':
                        periodKey = date.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const week = getWeekNumber(date);
                        periodKey = `${date.getFullYear()}-W${week.toString().padStart(2, '0')}`;
                        break;
                    case '15days':
                        const day15 = Math.ceil(date.getDate() / 15);
                        periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-Q${day15}`;
                        break;
                    case 'month':
                        periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        break;
                }
                
                if (!grouped[periodKey]) {
                    grouped[periodKey] = [];
                }
                grouped[periodKey].push(row);
            });
            
            return grouped;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function calculateAverage(data, kpi) {
            const values = data.map(row => parseFloat(row[kpi]) || 0).filter(val => val > 0);
            return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                let formatted = (num / 1000000).toFixed(2);
                // Rimuove gli zeri finali dopo la virgola
                formatted = formatted.replace(/\.?0+$/, '');
                return formatted.replace('.', ',') + 'M';
            }
            if (num >= 1000) {
                let formatted = (num / 1000).toFixed(2);
                // Rimuove gli zeri finali dopo la virgola
                formatted = formatted.replace(/\.?0+$/, '');
                return formatted.replace('.', ',') + 'K';
            }
            return Math.round(num).toString().replace('.', ',');
        }

        function formatPeriodLabel(periodKey, period) {
            switch (period) {
                case 'day':
                    return new Date(periodKey).toLocaleDateString('it-IT', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    });
                case 'week':
                    const [year, week] = periodKey.split('-W');
                    return `S${week}/${year.substr(2)}`;
                case '15days':
                    const [y, m, q] = periodKey.split('-');
                    const quarter = q === 'Q1' ? '1-15' : '16-31';
                    return `${quarter}/${m}`;
                case 'month':
                    const [yr, mn] = periodKey.split('-');
                    return `${mn}/${yr.substr(2)}`;
                default:
                    return periodKey;
            }
        }

        function createCharts(analysisData, topic, kpi, channel, period) {
            createMainChart(analysisData, topic, kpi, channel, period);
            createStatsChart(analysisData, topic, kpi);
        }

        function createMainChart(analysisData, topic, kpi, channel, period) {
            const svg = document.getElementById('chartPreview');
            svg.innerHTML = '';
            
            // Dimensioni adattive
            const containerWidth = Math.max(800, svg.clientWidth);
            const width = containerWidth;
            const height = 350;
            const margin = { top: 40, right: 30, bottom: 80, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // Colori
            const lightBlue = '#bfd7fd';
            const darkBlue = '#0066cc';
            const gray = '#3b3b3a';

            // Trova i valori massimi per la scala
            const maxValue = Math.max(...analysisData.map(d => Math.max(d.avgAll, d.avgTopic || 0)));
            const yScale = chartHeight / (maxValue * 1.2);

            // Larghezza delle barre
            const barWidth = Math.max(20, chartWidth / analysisData.length - 10);
            const barSpacing = chartWidth / analysisData.length;

            // Crea viewBox per mantenere le proporzioni
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            // Sfondo
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', 'white');
            svg.appendChild(rect);

            // Titolo
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', width / 2);
            title.setAttribute('y', 25);
            title.setAttribute('text-anchor', 'middle');
            title.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            title.setAttribute('font-size', '16');
            title.setAttribute('font-weight', 'bold');
            title.setAttribute('fill', darkBlue);
            title.textContent = `Benchmark ${kpi} - "${topic}" vs Media${channel !== 'tutti' ? ` (${channel})` : ''}`;
            svg.appendChild(title);

            // Griglia orizzontale
            const gridLines = 5;
            for (let i = 0; i <= gridLines; i++) {
                const y = margin.top + (chartHeight / gridLines) * i;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', margin.left);
                line.setAttribute('x2', margin.left + chartWidth);
                line.setAttribute('y1', y);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#e9ecef');
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);

                // Etichette Y
                const value = (maxValue * 1.2) * (gridLines - i) / gridLines;
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', margin.left - 10);
                label.setAttribute('y', y + 5);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                label.setAttribute('font-size', '12');
                label.setAttribute('fill', gray);
                label.textContent = formatNumber(value);
                svg.appendChild(label);
            }

            // Barre e marker
            analysisData.forEach((data, index) => {
                const x = margin.left + index * barSpacing + (barSpacing - barWidth) / 2;
                
                // Barra azzurra (media generale)
                const barHeight = data.avgAll * yScale;
                const barY = margin.top + chartHeight - barHeight;
                
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', x);
                bar.setAttribute('y', barY);
                bar.setAttribute('width', barWidth);
                bar.setAttribute('height', barHeight);
                bar.setAttribute('fill', lightBlue);
                svg.appendChild(bar);

                // Marker blu scuro (argomento specifico) se presente
                if (data.avgTopic !== null && data.avgTopic > 0) {
                    const markerY = margin.top + chartHeight - (data.avgTopic * yScale);
                    
                    // Cerchio marker
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    marker.setAttribute('cx', x + barWidth / 2);
                    marker.setAttribute('cy', markerY);
                    marker.setAttribute('r', '6');
                    marker.setAttribute('fill', darkBlue);
                    marker.setAttribute('stroke', 'white');
                    marker.setAttribute('stroke-width', '2');
                    svg.appendChild(marker);

                    // Etichetta valore
                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', x + barWidth / 2);
                    valueLabel.setAttribute('y', markerY - 15);
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                    valueLabel.setAttribute('font-size', '11');
                    valueLabel.setAttribute('font-weight', 'bold');
                    valueLabel.setAttribute('fill', darkBlue);
                    valueLabel.textContent = formatNumber(data.avgTopic);
                    svg.appendChild(valueLabel);
                }

                // Etichette asse X
                const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                xLabel.setAttribute('x', x + barWidth / 2);
                xLabel.setAttribute('y', margin.top + chartHeight + 20);
                xLabel.setAttribute('text-anchor', 'middle');
                xLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                xLabel.setAttribute('font-size', '12');
                xLabel.setAttribute('fill', gray);
                xLabel.textContent = formatPeriodLabel(data.period, period);
                svg.appendChild(xLabel);
            });

            // Legenda in basso a sinistra
            const legendX = margin.left;
            const legendY = margin.top + chartHeight + 50;
            
            // Legenda barra azzurra
            const legendBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            legendBar.setAttribute('x', legendX);
            legendBar.setAttribute('y', legendY);
            legendBar.setAttribute('width', '15');
            legendBar.setAttribute('height', '15');
            legendBar.setAttribute('fill', lightBlue);
            svg.appendChild(legendBar);

            const legendText1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            legendText1.setAttribute('x', legendX + 25);
            legendText1.setAttribute('y', legendY + 12);
            legendText1.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            legendText1.setAttribute('font-size', '12');
            legendText1.setAttribute('fill', gray);
            legendText1.textContent = 'Media generale';
            svg.appendChild(legendText1);

            // Legenda marker
            const legendMarker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            legendMarker.setAttribute('cx', legendX + 150);
            legendMarker.setAttribute('cy', legendY);
            legendMarker.setAttribute('r', '6');
            legendMarker.setAttribute('fill', darkBlue);
            svg.appendChild(legendMarker);

            const legendText2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            legendText2.setAttribute('x', legendX + 175);
            legendText2.setAttribute('y', legendY + 12);
            legendText2.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            legendText2.setAttribute('font-size', '12');
            legendText2.setAttribute('fill', gray);
            const truncatedTopic = topic.length > 20 ? topic.substring(0, 17) + '...' : topic;
            legendText2.textContent = `"${truncatedTopic}"`;
            svg.appendChild(legendText2);
        }

        function createStatsChart(analysisData, topic, kpi) {
            const svg = document.getElementById('statsPreview');
            svg.innerHTML = '';
            
            const width = 400;
            const height = 250;
            
            // Usa viewBox per mantenere le proporzioni
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            // Colori
            const lightBlue = '#bfd7fd';
            const darkBlue = '#0066cc';
            const gray = '#3b3b3a';

            // Sfondo
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', 'white');
            svg.appendChild(rect);

            // Titolo con argomento specifico tra virgolette
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', width / 2);
            title.setAttribute('y', 25);
            title.setAttribute('text-anchor', 'middle');
            title.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            title.setAttribute('font-size', '14');
            title.setAttribute('font-weight', 'bold');
            title.setAttribute('fill', darkBlue);
            title.textContent = `Riepilogo Statistiche - ${kpi}`;
            svg.appendChild(title);

            // Sottotitolo con argomento
            const subtitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            subtitle.setAttribute('x', width / 2);
            subtitle.setAttribute('y', 45);
            subtitle.setAttribute('text-anchor', 'middle');
            subtitle.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            subtitle.setAttribute('font-size', '12');
            subtitle.setAttribute('fill', gray);
            const truncatedTopic = topic.length > 30 ? topic.substring(0, 27) + '...' : topic;
            subtitle.textContent = `Argomento: "${truncatedTopic}"`;
            svg.appendChild(subtitle);

            // Calcola le statistiche
            const totalPosts = analysisData.reduce((sum, d) => sum + d.totalPosts, 0);
            const topicPostsCount = analysisData.reduce((sum, d) => sum + d.topicPosts, 0);
            const avgAll = analysisData.reduce((sum, d) => sum + d.avgAll, 0) / analysisData.length;
            const topicData = analysisData.filter(d => d.avgTopic !== null);
            const avgTopic = topicData.length > 0 ? 
                topicData.reduce((sum, d) => sum + d.avgTopic, 0) / topicData.length : 0;

            // Posizioni per i box informativi
            const boxes = [
                { label: 'Post Totali', value: totalPosts, x: 50, y: 85 },
                { label: 'Post Argomento', value: topicPostsCount, x: 250, y: 85 },
                { label: 'Media Generale', value: avgAll, x: 50, y: 145 },
                { label: 'Media Argomento', value: avgTopic, x: 250, y: 145 }
            ];

            boxes.forEach(box => {
                // Box
                const boxRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                boxRect.setAttribute('x', box.x - 40);
                boxRect.setAttribute('y', box.y - 20);
                boxRect.setAttribute('width', '130');
                boxRect.setAttribute('height', '50');
                boxRect.setAttribute('fill', lightBlue);
                boxRect.setAttribute('stroke', darkBlue);
                boxRect.setAttribute('rx', '5');
                svg.appendChild(boxRect);

                // Valore
                const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valueText.setAttribute('x', box.x + 25);
                valueText.setAttribute('y', box.y - 2);
                valueText.setAttribute('text-anchor', 'middle');
                valueText.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                valueText.setAttribute('font-size', '18');
                valueText.setAttribute('font-weight', 'bold');
                valueText.setAttribute('fill', darkBlue);
                valueText.textContent = formatNumber(box.value);
                svg.appendChild(valueText);

                // Etichetta
                const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelText.setAttribute('x', box.x + 25);
                labelText.setAttribute('y', box.y + 15);
                labelText.setAttribute('text-anchor', 'middle');
                labelText.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                labelText.setAttribute('font-size', '10');
                labelText.setAttribute('fill', gray);
                labelText.textContent = box.label;
                svg.appendChild(labelText);
            });
        }

        function updateStatistics(analysisData, topic, kpi) {
            const totalPosts = analysisData.reduce((sum, d) => sum + d.totalPosts, 0);
            const topicPostsCount = analysisData.reduce((sum, d) => sum + d.topicPosts, 0);
            const avgAll = analysisData.reduce((sum, d) => sum + d.avgAll, 0) / analysisData.length;
            const topicData = analysisData.filter(d => d.avgTopic !== null);
            const avgTopic = topicData.length > 0 ? 
                topicData.reduce((sum, d) => sum + d.avgTopic, 0) / topicData.length : 0;

            document.getElementById('totalPosts').textContent = formatNumber(totalPosts);
            document.getElementById('topicPosts').textContent = formatNumber(topicPostsCount);
            document.getElementById('avgOverall').textContent = formatNumber(avgAll);
            document.getElementById('avgTopic').textContent = formatNumber(avgTopic);
        }

        function downloadSVG(type) {
            const svgElement = type === 'chart' ? 
                document.getElementById('chartPreview') : 
                document.getElementById('statsPreview');
            
            const svgContent = new XMLSerializer().serializeToString(svgElement);
            const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = type === 'chart' ? 
                'grafico_benchmark.svg' : 
                'riepilogo_statistiche.svg';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            const button = type === 'chart' ? 
                document.getElementById('downloadChart') : 
                document.getElementById('downloadStats');
            
            const originalText = button.innerHTML;
            updateButtonState(button, 'success', originalText);
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Social Analytics Dashboard inizializzato');
        });
    </script>
</body>
</html>
