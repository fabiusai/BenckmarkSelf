<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Analytics Dashboard</title>
    <link rel="icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #3b3b3a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 102, 204, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #0066cc;
        }

        .section h2 {
            color: #0066cc;
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #3b3b3a;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3b3b3a;
        }

        input[type="file"],
        select,
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="file"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .search-container {
            position: relative;
        }

        .search-container input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .btn {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #0066cc;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0066cc;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: auto;
        }

        .error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        #chartPreview, #statsPreview {
            width: 100%;
            max-width: 100%;
            height: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Social Analytics Dashboard</h1>
            <p>Analizza le performance dei tuoi contenuti social con grafici professionali</p>
        </div>

        <!-- Sezione upload file -->
        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
                Carica i tuoi dati Excel
            </h2>
            <div class="form-group">
                <label for="fileInput">Seleziona il file Excel con i dati dei social media</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>
            <div id="fileStatus" class="loading">
                <div class="spinner"></div>
                Caricamento e analisi del file in corso...
            </div>
        </div>

        <!-- Sezione configurazione -->
        <div id="configSections" class="hidden">
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                    </svg>
                    Configurazione Analisi
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="topicFilter">Filtra argomenti</label>
                        <div class="search-container">
                            <input type="text" id="topicFilter" placeholder="Digita per filtrare..." />
                            <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20">
                                <path d="M15.5 14h-.79l-.28-.27A6.518 6.518 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5.5 12.49 5.5 11S7.01 8 9.5 8 13.5 9.51 13.5 11 11.99 14 9.5 14z" fill="currentColor"/>
                            </svg>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="topicSelect">Argomento da analizzare</label>
                        <select id="topicSelect">
                            <option value="">Seleziona un argomento...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kpiSelect">Metrica da analizzare</label>
                        <select id="kpiSelect">
                            <option value="Interazioni">Interazioni</option>
                            <option value="Visualizzazioni">Visualizzazioni</option>
                            <option value="Persone raggiunte">Persone raggiunte</option>
                            <option value="Click">Click</option>
                            <option value="Like e reazioni">Like e reazioni</option>
                            <option value="Condivisioni">Condivisioni</option>
                            <option value="Commenti">Commenti</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="channelSelect">Canale</label>
                        <select id="channelSelect">
                            <option value="tutti">Tutti i canali</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="periodSelect">Raggruppamento temporale</label>
                        <select id="periodSelect">
                            <option value="day">Giornaliero</option>
                            <option value="week">Settimanale</option>
                            <option value="15days">Quindicinale</option>
                            <option value="month" selected>Mensile</option>
                        </select>
                    </div>
                </div>

                <button id="generateBtn" class="btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3,3H11V7H7V11H3V3M13,3H21V7H17V11H13V3M3,13H11V17H7V21H3V13M13,13H21V17H17V21H13V13Z" />
                    </svg>
                    Genera Analisi Benchmark
                </button>
            </div>
        </div>

        <!-- Sezione risultati -->
        <div id="resultsSection" class="hidden">
            <div class="section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3,3V21H21V19H5V3H3M7,17H9V10H7V17M11,17H13V6H11V17M15,17H17V12H15V17M19,17H21V8H19V17Z" />
                    </svg>
                    Risultati dell'Analisi
                </h2>

                <!-- Statistiche numeriche -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="totalPosts" class="stat-value">-</div>
                        <div class="stat-label">Post Totali</div>
                    </div>
                    <div class="stat-card">
                        <div id="topicPosts" class="stat-value">-</div>
                        <div class="stat-label">Post Argomento</div>
                    </div>
                    <div class="stat-card">
                        <div id="avgOverall" class="stat-value">-</div>
                        <div class="stat-label">Media Generale</div>
                    </div>
                    <div class="stat-card">
                        <div id="avgTopic" class="stat-value">-</div>
                        <div class="stat-label">Media Argomento</div>
                    </div>
                </div>

                <!-- Grafico benchmark -->
                <div class="chart-container">
                    <h3>Grafico Benchmark</h3>
                    <svg id="chartPreview" width="100%" height="300" style="border: 2px solid #e9ecef; border-radius: 8px;">
                        <text x="50%" y="50%" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" fill="#666">
                            Genera un'analisi per visualizzare il grafico
                        </text>
                    </svg>
                </div>

                <!-- Riepilogo statistiche -->
                <div class="chart-container">
                    <h3>Riepilogo Statistiche</h3>
                    <svg id="statsPreview" width="100%" height="200" style="border: 2px solid #e9ecef; border-radius: 8px;">
                        <text x="50%" y="50%" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" fill="#666">
                            Genera un'analisi per visualizzare le statistiche
                        </text>
                    </svg>
                </div>

                <!-- Sezione download -->
                <div class="download-section">
                    <button id="downloadChart" class="btn btn-secondary" onclick="downloadSVG('chart')">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        Scarica Grafico SVG
                    </button>
                    <button id="downloadStats" class="btn btn-secondary" onclick="downloadSVG('stats')">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        Scarica Statistiche SVG
                    </button>
                </div>
            </div>
        </div>

        <!-- Messaggio di stato -->
        <div id="message" class="hidden"></div>
    </div>

    <!-- XLSX library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Variabili globali
        let excelData = [];
        let allTopics = [];
        let allChannels = [];

        // Riferimenti DOM
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');
        const configSections = document.getElementById('configSections');
        const resultsSection = document.getElementById('resultsSection');
        const topicFilter = document.getElementById('topicFilter');
        const topicSelect = document.getElementById('topicSelect');
        const kpiSelect = document.getElementById('kpiSelect');
        const channelSelect = document.getElementById('channelSelect');
        const periodSelect = document.getElementById('periodSelect');
        const generateBtn = document.getElementById('generateBtn');
        const messageDiv = document.getElementById('message');

        // Event listeners
        fileInput.addEventListener('change', handleFileUpload);
        topicFilter.addEventListener('input', filterTopics);
        generateBtn.addEventListener('click', generateAnalysis);

        function showMessage(message, isError = false) {
            messageDiv.textContent = message;
            messageDiv.className = isError ? 'error' : 'success';
            messageDiv.classList.remove('hidden');
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        function updateButtonState(button, state, originalText) {
            switch(state) {
                case 'loading':
                    button.disabled = true;
                    button.innerHTML = '<div class="spinner"></div> Caricamento...';
                    break;
                case 'success':
                    button.disabled = true;
                    button.innerHTML = '✓ Completato!';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                    break;
                case 'error':
                    button.disabled = true;
                    button.innerHTML = '✗ Errore';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                    break;
                default:
                    button.disabled = false;
                    button.innerHTML = originalText;
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileStatus.style.display = 'block';
            
            try {
                const data = await readExcelFile(file);
                processExcelData(data);
                populateSelectors();
                configSections.classList.remove('hidden');
                showMessage('File caricato con successo!', false);
            } catch (error) {
                console.error('Errore nel caricamento:', error);
                showMessage('Errore nel caricamento del file. Verificare il formato.', true);
            }
            
            fileStatus.style.display = 'none';
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function processExcelData(data) {
            // Filtra solo i dati con Campagna = "Editoriale"
            excelData = data.filter(row => 
                row.Campagna && row.Campagna.toString().toLowerCase() === 'editoriale'
            );

            if (excelData.length === 0) {
                throw new Error('Nessun dato trovato con Campagna = "Editoriale"');
            }

            // Estrai argomenti e canali unici
            allTopics = [...new Set(excelData.map(row => row.Argomento).filter(Boolean))].sort();
            allChannels = [...new Set(excelData.map(row => row.Canale).filter(Boolean))].sort();

            console.log(`Caricati ${excelData.length} record con Campagna "Editoriale"`);
            console.log('Argomenti trovati:', allTopics);
            console.log('Canali trovati:', allChannels);
        }

        function populateSelectors() {
            // Popola argomenti
            topicSelect.innerHTML = '<option value="">Seleziona un argomento...</option>';
            allTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });

            // Popola canali
            channelSelect.innerHTML = '<option value="tutti">Tutti i canali</option>';
            allChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
        }

        function filterTopics() {
            const filter = topicFilter.value.toLowerCase();
            
            // Prima rimuovi tutte le opzioni tranne la prima
            const firstOption = topicSelect.children[0];
            topicSelect.innerHTML = '';
            topicSelect.appendChild(firstOption);
            
            // Aggiungi solo le opzioni che corrispondono al filtro
            allTopics.forEach(topic => {
                if (topic.toLowerCase().includes(filter)) {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    topicSelect.appendChild(option);
                }
            });
        }

        function generateAnalysis() {
            const topic = topicSelect.value;
            const kpi = kpiSelect.value;
            const channel = channelSelect.value;
            const period = periodSelect.value;

            if (!topic) {
                showMessage('Seleziona un argomento per continuare.', true);
                return;
            }

            const originalText = generateBtn.innerHTML;
            updateButtonState(generateBtn, 'loading', originalText);

            try {
                const analysisData = prepareAnalysisData(topic, kpi, channel, period);
                createCharts(analysisData, topic, kpi, channel, period);
                updateStatistics(analysisData, topic, kpi);
                
                resultsSection.classList.remove('hidden');
                updateButtonState(generateBtn, 'success', originalText);
                showMessage('Analisi generata con successo!', false);
                
                // Scroll to results
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Errore nella generazione:', error);
                updateButtonState(generateBtn, 'error', originalText);
                showMessage('Errore nella generazione dell\'analisi.', true);
            }
        }

        function prepareAnalysisData(topic, kpi, channel, period) {
            // Filtra i dati in base al canale
            let workingData = excelData;
            if (channel !== 'tutti') {
                workingData = excelData.filter(row => row.Canale === channel);
            }

            // Converti le date e raggruppa per periodo
            const groupedData = groupByPeriod(workingData, period);
            
            // Calcola medie per periodo
            const analysisData = [];
            
            Object.keys(groupedData).sort().forEach(periodKey => {
                const periodData = groupedData[periodKey];
                const allPosts = periodData;
                const topicPosts = periodData.filter(row => row.Argomento === topic);
                
                if (allPosts.length > 0) {
                    const avgAll = calculateAverage(allPosts, kpi);
                    const avgTopic = topicPosts.length > 0 ? calculateAverage(topicPosts, kpi) : null;
                    
                    // Solo se ci sono dati validi per il periodo
                    if (avgAll > 0 || avgTopic > 0) {
                        analysisData.push({
                            period: periodKey,
                            avgAll: avgAll,
                            avgTopic: avgTopic,
                            totalPosts: allPosts.length,
                            topicPosts: topicPosts.length
                        });
                    }
                }
            });

            console.log('Analysis data prepared:', analysisData);
            return analysisData;
        }

        // FUNZIONE CORRETTA: Parsing migliorato delle date
        function groupByPeriod(data, period) {
            const grouped = {};
            
            data.forEach(row => {
                if (!row.Data) return;
                
                let date;
                try {
                    if (typeof row.Data === 'number') {
                        // Date Excel in formato numerico
                        date = new Date((row.Data - 25569) * 86400 * 1000);
                    } else if (typeof row.Data === 'string') {
                        // Gestione del formato DD/MM/YYYY italiano
                        if (row.Data.includes('/')) {
                            const parts = row.Data.split('/');
                            if (parts.length === 3) {
                                // Formato DD/MM/YYYY -> crea Date(YYYY, MM-1, DD)
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // I mesi in JavaScript sono 0-based
                                const year = parseInt(parts[2]);
                                date = new Date(year, month, day);
                            } else {
                                date = new Date(row.Data);
                            }
                        } else {
                            date = new Date(row.Data);
                        }
                    } else if (row.Data instanceof Date) {
                        // Già un oggetto Date
                        date = new Date(row.Data);
                    } else {
                        date = new Date(row.Data);
                    }
                } catch (error) {
                    console.warn('Errore nel parsing della data:', row.Data, error);
                    return; // Salta righe con date non valide
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Data non valida:', row.Data);
                    return;
                }
                
                let periodKey;
                switch (period) {
                    case 'day':
                        periodKey = date.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const week = getWeekNumber(date);
                        periodKey = `${date.getFullYear()}-W${week.toString().padStart(2, '0')}`;
                        break;
                    case '15days':
                        const day15 = Math.ceil(date.getDate() / 15);
                        periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-Q${day15}`;
                        break;
                    case 'month':
                        periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        break;
                }
                
                if (!grouped[periodKey]) {
                    grouped[periodKey] = [];
                }
                grouped[periodKey].push(row);
            });
            
            return grouped;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function calculateAverage(data, kpi) {
            // Filtra solo i valori numerici validi (non null, non undefined, non NaN)
            const values = data.map(row => {
                const val = parseFloat(row[kpi]);
                return isNaN(val) ? null : val;
            }).filter(val => val !== null);
            
            return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                let formatted = (num / 1000000).toFixed(2);
                // Rimuove gli zeri finali dopo la virgola
                formatted = formatted.replace(/\.?0+$/, '');
                return formatted.replace('.', ',') + 'M';
            }
            if (num >= 1000) {
                let formatted = (num / 1000).toFixed(2);
                // Rimuove gli zeri finali dopo la virgola
                formatted = formatted.replace(/\.?0+$/, '');
                return formatted.replace('.', ',') + 'K';
            }
            return Math.round(num).toString().replace('.', ',');
        }

        function formatPeriodLabel(periodKey, period) {
            switch (period) {
                case 'day':
                    return new Date(periodKey).toLocaleDateString('it-IT', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    });
                case 'week':
                    const [year, week] = periodKey.split('-W');
                    return `S${week}/${year.substr(2)}`;
                case '15days':
                    const [y, m, q] = periodKey.split('-');
                    const quarter = q === 'Q1' ? '1-15' : '16-31';
                    return `${quarter}/${m}`;
                case 'month':
                    const [yr, mn] = periodKey.split('-');
                    return `${mn}/${yr.substr(2)}`;
                default:
                    return periodKey;
            }
        }

        function createCharts(analysisData, topic, kpi, channel, period) {
            createMainChart(analysisData, topic, kpi, channel, period);
            createStatsChart(analysisData, topic, kpi);
        }

        function createMainChart(analysisData, topic, kpi, channel, period) {
            const svg = document.getElementById('chartPreview');
            svg.innerHTML = '';
            
            const width = 1200; // Nuova larghezza
            const height = 300; // Nuova altezza
            const margin = { top: 40, right: 40, bottom: 50, left: 80 }; // Più spazio a sinistra per scala Y
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // Usa viewBox per mantenere le proporzioni
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            // Colori
            const lightBlue = '#d6e6fe'; // Colore azzurro più chiaro
            const darkBlue = '#0066cc';
            const gray = '#999999'; // Colore grigio più chiaro
            const darkGray = '#3b3b3a';

            // Sfondo trasparente (rimosso)

            // Titolo rimosso

            if (analysisData.length === 0) return;

            // Calcola le scale
            const maxValue = Math.max(...analysisData.flatMap(d => [d.avgAll, d.avgTopic || 0]));
            const yScale = maxValue > 0 ? chartHeight / maxValue : 1;

            const barWidth = chartWidth / analysisData.length * 0.8;
            const barSpacing = chartWidth / analysisData.length * 0.2;

            // Scala Y - Aggiungi linee orizzontali e etichette
            const numTicks = 5;
            for (let i = 0; i <= numTicks; i++) {
                const tickValue = (maxValue / numTicks) * i;
                const yPos = margin.top + chartHeight - (tickValue * yScale);

                // Linea orizzontale della griglia (opzionale, molto sottile)
                if (i > 0) {
                    const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    gridLine.setAttribute('x1', margin.left);
                    gridLine.setAttribute('y1', yPos);
                    gridLine.setAttribute('x2', margin.left + chartWidth);
                    gridLine.setAttribute('y2', yPos);
                    gridLine.setAttribute('stroke', '#f8f8f8');
                    gridLine.setAttribute('stroke-width', '0.5');
                    svg.appendChild(gridLine);
                }

                // Etichetta numerica grigia sull'asse Y
                const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                yLabel.setAttribute('x', margin.left - 10);
                yLabel.setAttribute('y', yPos + 4);
                yLabel.setAttribute('text-anchor', 'end');
                yLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                yLabel.setAttribute('font-size', '11');
                yLabel.setAttribute('fill', gray);
                yLabel.textContent = formatNumber(tickValue);
                svg.appendChild(yLabel);
            }

            // Asse Y
            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('x1', margin.left);
            yAxis.setAttribute('y1', margin.top);
            yAxis.setAttribute('x2', margin.left);
            yAxis.setAttribute('y2', margin.top + chartHeight);
            yAxis.setAttribute('stroke', '#cccccc');
            yAxis.setAttribute('stroke-width', '0.5');
            svg.appendChild(yAxis);

            // Asse X
            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('x1', margin.left);
            xAxis.setAttribute('y1', margin.top + chartHeight);
            xAxis.setAttribute('x2', margin.left + chartWidth);
            xAxis.setAttribute('y2', margin.top + chartHeight);
            xAxis.setAttribute('stroke', '#cccccc');
            xAxis.setAttribute('stroke-width', '0.5');
            svg.appendChild(xAxis);

            // Dati e barre
            analysisData.forEach((data, index) => {
                const x = margin.left + index * (chartWidth / analysisData.length) + barSpacing / 2;

                // Barra per media generale (senza bordo)
                const barHeight = data.avgAll * yScale;
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', x);
                bar.setAttribute('y', margin.top + chartHeight - barHeight);
                bar.setAttribute('width', barWidth);
                bar.setAttribute('height', barHeight);
                bar.setAttribute('fill', lightBlue);
                // Rimossi stroke e stroke-width (niente bordi blu)
                svg.appendChild(bar);

                // Etichette valore barra RIMOSSE per evitare sovrapposizioni

                // Marker per argomento specifico
                if (data.avgTopic !== null) {
                    const markerY = margin.top + chartHeight - (data.avgTopic * yScale);
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    marker.setAttribute('cx', x + barWidth / 2);
                    marker.setAttribute('cy', markerY);
                    marker.setAttribute('r', '6');
                    marker.setAttribute('fill', darkBlue);
                    marker.setAttribute('stroke', 'white');
                    marker.setAttribute('stroke-width', '2');
                    svg.appendChild(marker);

                    // Etichetta marker (manteniamo questa per il valore specifico del topic)
                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', x + barWidth / 2);
                    valueLabel.setAttribute('y', markerY - 15);
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                    valueLabel.setAttribute('font-size', '14'); // Font più grande per valori argomento
                    valueLabel.setAttribute('font-weight', 'bold');
                    valueLabel.setAttribute('fill', darkBlue);
                    valueLabel.textContent = formatNumber(data.avgTopic);
                    svg.appendChild(valueLabel);
                }

                // Etichette asse X
                const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                xLabel.setAttribute('x', x + barWidth / 2);
                xLabel.setAttribute('y', margin.top + chartHeight + 20);
                xLabel.setAttribute('text-anchor', 'middle');
                xLabel.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                xLabel.setAttribute('font-size', '12');
                xLabel.setAttribute('fill', darkGray);
                xLabel.textContent = formatPeriodLabel(data.period, period);
                svg.appendChild(xLabel);
            });

            // Legenda rimossa come richiesto
        }

        function createStatsChart(analysisData, topic, kpi) {
            const svg = document.getElementById('statsPreview');
            svg.innerHTML = '';
            
            const width = 400;
            const height = 200; // Altezza ridotta per design più compatto
            
            // Usa viewBox per mantenere le proporzioni
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            // Colori
            const lightBlue = '#d6e6fe';
            const darkBlue = '#0066cc';
            const gray = '#666666';

            // Sfondo trasparente (rimosso)

            // CORREZIONE: Calcola le statistiche correttamente
            // Somma diretta dei post da excelData invece che dai periodi raggruppati
            let totalPosts, topicPostsCount;
            
            // Filtra i dati in base al canale (stesso filtro usato nell'analisi)
            let filteredData = excelData;
            if (document.getElementById('channelSelect').value !== 'tutti') {
                filteredData = excelData.filter(row => row.Canale === document.getElementById('channelSelect').value);
            }
            
            totalPosts = filteredData.length;
            
            // Conta i post con l'argomento specifico (case-insensitive)
            const topicLower = topic.toLowerCase();
            topicPostsCount = filteredData.filter(row => 
                row.Argomento && row.Argomento.toLowerCase().includes(topicLower)
            ).length;

            if (totalPosts === 0 || !analysisData || analysisData.length === 0) {
                const noDataText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                noDataText.setAttribute('x', width / 2);
                noDataText.setAttribute('y', height / 2);
                noDataText.setAttribute('text-anchor', 'middle');
                noDataText.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
                noDataText.setAttribute('font-size', '14');
                noDataText.setAttribute('fill', gray);
                noDataText.textContent = 'Nessun dato disponibile per la visualizzazione.';
                svg.appendChild(noDataText);
                return;
            }

            // Calcola il valore medio dell'argomento
            const avgTopicValue = analysisData.reduce((sum, d) => sum + (d.avgTopic || 0), 0) / analysisData.length;
            
            // Layout per gli indicatori
            const indicatorSpacing = width / 3;
            const yPos = height / 2;

            // Indicatore 1: Posts Totali
            createIndicator(svg, indicatorSpacing * 0.5, yPos, formatNumber(totalPosts), 'Posts Totali', gray);
            
            // Indicatore 2: Posts Argomento
            createIndicator(svg, indicatorSpacing * 1.5, yPos, formatNumber(topicPostsCount), `Posts "${topic.length > 20 ? topic.substring(0, 17) + '...' : topic}"`, darkBlue);
            
            // Indicatore 3: Media KPI
            createIndicator(svg, indicatorSpacing * 2.5, yPos, formatNumber(avgTopicValue), `Media ${kpi}`, darkBlue);
        }

        // Funzione helper per creare indicatori semplificati
        function createIndicator(svg, x, y, value, label, color) {
            // Valore principale
            const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            valueText.setAttribute('x', x);
            valueText.setAttribute('y', y - 10);
            valueText.setAttribute('text-anchor', 'middle');
            valueText.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            valueText.setAttribute('font-size', '24');
            valueText.setAttribute('font-weight', 'bold');
            valueText.setAttribute('fill', color);
            valueText.textContent = value;
            svg.appendChild(valueText);

            // Cerchio decorativo
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y + 15);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', color);
            svg.appendChild(circle);

            // Label
            const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelText.setAttribute('x', x);
            labelText.setAttribute('y', y + 35);
            labelText.setAttribute('text-anchor', 'middle');
            labelText.setAttribute('font-family', 'Avenir Next LT Pro, sans-serif');
            labelText.setAttribute('font-size', '11');
            labelText.setAttribute('fill', '#999999');
            labelText.textContent = label;
            svg.appendChild(labelText);
        }

        // CORREZIONE: Aggiorna la funzione updateStatistics per usare il conteggio diretto
        function updateStatistics(analysisData, topic, kpi) {
            // Filtra i dati in base al canale (stesso filtro usato nell'analisi)
            let filteredData = excelData;
            if (document.getElementById('channelSelect').value !== 'tutti') {
                filteredData = excelData.filter(row => row.Canale === document.getElementById('channelSelect').value);
            }
            
            const totalPosts = filteredData.length;
            const topicPostsCount = filteredData.filter(row => row.Argomento === topic).length;
            
            // Calcola medie più accurate usando solo periodi con dati validi
            const validPeriods = analysisData.filter(d => d.avgAll > 0);
            const avgAll = validPeriods.length > 0 ? 
                validPeriods.reduce((sum, d) => sum + d.avgAll, 0) / validPeriods.length : 0;
            
            const topicPeriods = analysisData.filter(d => d.avgTopic !== null && d.avgTopic > 0);
            const avgTopic = topicPeriods.length > 0 ? 
                topicPeriods.reduce((sum, d) => sum + d.avgTopic, 0) / topicPeriods.length : 0;

            console.log('Statistics calculated:', {
                totalPosts, topicPostsCount, avgAll, avgTopic,
                validPeriods: validPeriods.length, topicPeriods: topicPeriods.length
            });

            document.getElementById('totalPosts').textContent = formatNumber(totalPosts);
            document.getElementById('topicPosts').textContent = formatNumber(topicPostsCount);
            document.getElementById('avgOverall').textContent = formatNumber(avgAll);
            document.getElementById('avgTopic').textContent = formatNumber(avgTopic);
        }

        function downloadSVG(type) {
            const svgElement = type === 'chart' ? 
                document.getElementById('chartPreview') : 
                document.getElementById('statsPreview');
            
            const svgContent = new XMLSerializer().serializeToString(svgElement);
            const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = type === 'chart' ? 
                'grafico_benchmark.svg' : 
                'riepilogo_statistiche.svg';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            const button = type === 'chart' ? 
                document.getElementById('downloadChart') : 
                document.getElementById('downloadStats');
            
            const originalText = button.innerHTML;
            updateButtonState(button, 'success', originalText);
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Social Analytics Dashboard inizializzato');
        });
    </script>
</body>
</html>
